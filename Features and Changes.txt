Building on top and modification of the GNU GENERAL PUBLIC LICENSE code of the Advanced Kombat (5e) Fantasy Grounds extension by Ken L.
Modifications by Styrmir from December 2018 onwards.

//////////////////////////////////////////
Changelog / Added / Modified:
(Most of these can be reverted by commenting out the modification you don't want to use)
Versioning: v(Major.Minor.Patch) https://en.wikipedia.org/wiki/Software_versioning

v1.1.0 (December, 26, 2018) (major features)
- Created new loading icon.
- Version checking. Changed to check for version 3.3.7 as core of module is working for that version. [scripts/manager_versionchk.lua]
    Currently only works with regular image view panel, not the background versions added in 3.3.7, as it relies on layers support by https://www.fantasygrounds.com/forums/showthread.php?20231-Enhanced-Images-(layers)-for-FG-3-0-CoreRPG-(and-rulesets-based-on-CoreRPG).
- Combat tracker. Effects icon change. [graphics/graphics_buttons.xlm]
    Changed icon for effects in combat tracker to be the same as in the CoreRPG set (the little man/woman), and on the actions section of character sheets.
    Edited image to make it fit better with the others in the CT. Removed most of the sheen around the image, enlarged it, added a tint of brown to the image.
- Images in regular view given a black backround/mask color. Graphics based on default theme. [extension.xml]
- Blood Splatter and Pointer Graphics to Copy. Folder added containing blood splatter and pointer graphics. Open the folder for directions where to copy to make it work in-game.
- Fast deletion of Tokens. [scripts/modifications.lua]
    Deletes token from combat map for host, if left-clicked  while Alt key is held down.
    Deletes token from combat map and combat tracker for host, if left-clicked while Alt + Control keys are held down.
    ps. note that dead tokens are on the second layer, and blood splatter is on the third.        

v1.2.0 (December 27, 2018) (major features)
- Horizontal health bars, slightly less than token width when full health, appear above token. Larger and more easily readable. Resize and relocate ratio wise to account for different grid and resolutions sizes. Light transparency added to health bar. [ new horizontal health bar graphics, graphics/graphics_icons.xml, manager_token2.lua > function updateHealthBarScale(tokenCT, nodeCT) ; function updateHealthHelper(tokenCT, nodeCT) ]
    Health bars dissapear when no health left (incapacitated/dead).            
- Dot health indicators roughly doubled in size for better readability. Resize and relocate ratio wise to account for different grid and resolutions sizes. [ updated graphics for health dot, relocated dot to align due to increased dimensions, manager_token2.lua > updateHealthHelper(tokenCT, nodeCT) ]

v1.2.1 (patch)
- Blood Splatter and Pointer Graphics to Copy.zip. Fixed directory instructions for "Where to place to work.txt". Set to default of "Fantasy Grounds Data/tokens/".
- Token highlight underlays made more transparent (20%), so the effect is softer and less visually distracting. Thanks to AlphaDecay for the suggestion. [11 instances of token.addUnderlay() in: scripts\modifications.lua, scripts\manager_token.lua (two spots in hilightHover, scripts\manager_maptoken.lua (one in prepMapToken, one in initMapTokens, one in initSingleToken, two in onCTMenuSelection), scripts\snap_token.lua (one in customTurnStart), ct\scripts\ct_token.lua (two in onHover), ct\scripts\ct_entry.lua (one in activeHighlight)]
    Constant colors used are set in scripts/modifications.lua (TOKENUNDERLAYCOLOR_1, TOKENUNDERLAYCOLOR_2, TOKENUNDERLAYCOLOR_3). You can change them there and they will be changed over the whole extension in the appropriate places after save and reload.
    Replaced in files: AA00FF00 with 3300FF00, AAF9FF44 with 33F9FF44, AA0000FF with 330000FF.
    First two numbers/letters refer to the alpha channel or transparency levels. Alpha channel (ranging from 0-255) in hex, opacity at 40% = 66, 30% = 4D , 20% = 33, 10% = 1A    
- Incorrect console message on version checking. Referred to Advanced Kombat, fixed to refer to 5e Combat Enhancer. [manager_versionchk.lua]



Working on a Non-Layered alternative version. This would allow for setting images as backgrounds (as added by 3.3.7) but it does disable some functionality. Currently what I've found during testing is that it has the following effect.:
- Blood splatter no longer works.
- Adding pre-placed monsters from Encounters, adds monsters to Combat Tracker, but fails to add them to the map itself.

//////////////////////////////////////////
TODO/Wishlist:


Dynamic shadow in grids.

Change color of mouse default mouse pointer when it can interact, instead of a hand icon (which makes it hard to find where the actual interaction point is).
- Do some photoshop work and add customer graphics to extension for this.
See: http://www.fantasygrounds.com/wiki/index.php/Custom_Pointers_Coding_Toolkit
https://www.fantasygrounds.com/forums/showthread.php?47108-Trying-to-create-an-extension-to-change-appearance-of-the-mouse-cursor

Update code with updated layers code after it's been fixed to work for 3.3.7. Allowing for putting battlemaps in the background.
https://www.fantasygrounds.com/forums/showthread.php?20231-Enhanced-Images-(layers)-for-FG-3-0-CoreRPG-(and-rulesets-based-on-CoreRPG)

Add black background instead of grey background/mask for the various "zooms" of the battlemaps.

Working on a Non-Layered alternate version. This would allow for setting images as backgrounds (as added by 3.3.7) but it does disable some functionality. Currently what I've found during testing is that it has the following effect.:
- Blood splatter no longer works.
- Adding pre-placed monsters from Encounters, adds monsters to Combat Tracker, but fails to add them to the map itself.

Automated ranged weapon disadvantage when outside range (missing from 5e ruleset, but used in SW, can look there for ideas). Have to have target set, distances between pointers used, look up weapon range, compare, apply disadvantage if applicable.
Ranged modifiers to attacks work testing started. Adds disadvantage if targeted token is outside of short range. Autofail if outside max range. [ manager_token2.lua > function getDistance(nodeAttacker, nodeTarget) ; function getTokenDistance(ctrlImage, tokenTargeter, tokenTarget) ]

Change opacity values of token background layers in settings menu.

//////////////////////////////////////////
User requests:

>> Menu options to hide blood splatter on death and death indication in CT and from combat map graphics. 
>> https://www.fantasygrounds.com/forums/showthread.php?47146-5e-Combat-Enhancer-(built-on-retired-GPL-Advanced-Kombat-extension)/page6
I'd like to not immediately reveal when certain NPC's dies so there can be a bit of narration, either on my part or the players, for the death of a boss for example.
Would it be possible to perhaps have it look for a specific effect that makes it not auto-death that creature when it reaches 0 hit points?
Second-best would be the ability to disable this part of the extension altogether I suppose 

In vanilla you can completely hide the status of an NPC from the players by setting
Code:

Token (GM)
Player: Show Enemy Health => Off

and
Code:

Combat (GM) 
View: Health - Non-ally => Off

With both of these settings set to off the players cannot see if an NPC is healthy, critical or unconscious either in the CT or on the map.
Now, with Combat Enhancer, even with these options set up this way, once an NPC dies the entry in the combat tracker fades, there's a skull on the token on the map, and the token is moved to the bottom layers meaning the players can no longer interact with it. It's very obvious it's dead.
Now, while writing this I thought of a good potential solution, though I have little to no experience with FG extensions so I don't know if it's possible. But I'd love if you could optionally have it stop dealing damage automatically to an NPC once it's at 1 hp.
For example, Dr Doom starts out with 100 hp, fights the party for some time and now has 10 hp left.
Someone fires a fireball at him dealing 24 damage to him. Normally this would make him go unconscious and instantly tell the players he's down. But instead he now has 1 hp left, leaving me time to either narrate how the fireball incinerates him, leaving the players in suspense for a little bit, or, as Matt Mercer would say "How do you want to do this?".
Once either of these things have transpired I can then manually set Dr Dooms hit points to 0, thus triggering the indicators that he's down.
Do you think this would be possible? 